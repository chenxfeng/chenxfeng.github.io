<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="computer network," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="multimedia networking applicationsMultimedia: audio
analog audio signal sampled at constant rate

telephone: 8,000 samples/sec



CD music: 44,100 samples/sec


each sample quantized, i.e., rounded">
<meta property="og:type" content="article">
<meta property="og:title" content="多媒体网络(Multimedia Networking)">
<meta property="og:url" content="https://chenfeng.github.io/2017/06/29/computer_network/computer_network_7：多媒体网络(Multimedia Networking)/index.html">
<meta property="og:site_name" content="chenxfeng's blog">
<meta property="og:description" content="multimedia networking applicationsMultimedia: audio
analog audio signal sampled at constant rate

telephone: 8,000 samples/sec



CD music: 44,100 samples/sec


each sample quantized, i.e., rounded">
<meta property="og:image" content="https://chenfeng.github.io/\img\multimedia_audio.png">
<meta property="og:image" content="https://chenfeng.github.io/\img\multimedia_video.png">
<meta property="og:image" content="https://chenfeng.github.io/\img\streaming_stored_video.png">
<meta property="og:image" content="https://chenfeng.github.io/\img\streaming_stored_video_revisited.png">
<meta property="og:image" content="https://chenfeng.github.io/\img\streaming_stored_video_clientSideBuffering.png">
<meta property="og:image" content="https://chenfeng.github.io/\img\VoIP_fixed_playout_delay.png">
<meta property="og:image" content="https://chenfeng.github.io/\img\VoIP_adaptive_playout_delay.png">
<meta property="og:image" content="https://chenfeng.github.io/\img\VoIP_recovery_from_packet_loss.png">
<meta property="og:image" content="https://chenfeng.github.io/\img\VoIP_recovery_from_packet_loss2.png">
<meta property="og:image" content="https://chenfeng.github.io/\img\Voice_over_IP_Skype.png">
<meta property="og:image" content="https://chenfeng.github.io/\img\Voice_over_IP_Skype2.png">
<meta property="og:image" content="https://chenfeng.github.io/\img\RTP.png">
<meta property="og:image" content="https://chenfeng.github.io/\img\RTP_header.png">
<meta property="og:image" content="https://chenfeng.github.io/\img\RTCP.png">
<meta property="og:image" content="https://chenfeng.github.io/\img\SIP_setting_up_call.png">
<meta property="og:image" content="https://chenfeng.github.io/\img\SIP_example.png">
<meta property="og:image" content="https://chenfeng.github.io/\img\network_support_for_multimedia.png">
<meta property="og:image" content="https://chenfeng.github.io/\img\QoS_guarantee.png">
<meta property="og:image" content="https://chenfeng.github.io/\img\token_bucket.png">
<meta property="og:image" content="https://chenfeng.github.io/\img\QoS_tokenBucket_WFQ.png">
<meta property="og:image" content="https://chenfeng.github.io/\img\diffserv_architecture.png">
<meta property="og:image" content="https://chenfeng.github.io/\img\classification_conditioning.png">
<meta property="og:updated_time" content="2017-07-01T14:04:04.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="多媒体网络(Multimedia Networking)">
<meta name="twitter:description" content="multimedia networking applicationsMultimedia: audio
analog audio signal sampled at constant rate

telephone: 8,000 samples/sec



CD music: 44,100 samples/sec


each sample quantized, i.e., rounded">
<meta name="twitter:image" content="https://chenfeng.github.io/\img\multimedia_audio.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.2',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://chenfeng.github.io/2017/06/29/computer_network/computer_network_7：多媒体网络(Multimedia Networking)/"/>





  <title>多媒体网络(Multimedia Networking) | chenxfeng's blog</title><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">chenxfeng's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://chenfeng.github.io/2017/06/29/computer_network/computer_network_7：多媒体网络(Multimedia Networking)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="chenxf">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/img/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="chenxfeng's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">多媒体网络(Multimedia Networking)</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-06-29T00:00:00+08:00">
                2017-06-29
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="multimedia-networking-applications"><a href="#multimedia-networking-applications" class="headerlink" title="multimedia networking applications"></a>multimedia networking applications</h2><h3 id="Multimedia-audio"><a href="#Multimedia-audio" class="headerlink" title="Multimedia: audio"></a>Multimedia: audio</h3><ul>
<li>analog audio signal sampled at constant rate</li>
<li><ul>
<li>telephone: 8,000 samples/sec</li>
</ul>
</li>
<li><ul>
<li>CD music: 44,100 samples/sec</li>
</ul>
</li>
<li><p>each sample quantized, i.e., rounded</p>
</li>
<li><ul>
<li>e.g., 2^8=256 possible quantized values</li>
</ul>
</li>
<li><ul>
<li>each quantized value represented by bits, e.g., 8 bits for 256 values</li>
</ul>
</li>
</ul>
<blockquote>
<p><img src="\img\multimedia_audio.png" alt="multimedia_audio.png"></p>
</blockquote>
<ul>
<li>example: 8,000 samples/sec, 256 quantized values: 64,000 bps</li>
<li><ul>
<li>1 byte per sample, 8 bit * 8000 = 64,000 bps</li>
</ul>
</li>
<li>receiver converts bits back to analog signal:</li>
<li><ul>
<li>some quality reduction</li>
</ul>
</li>
</ul>
<a id="more"></a>
<ul>
<li>example rates</li>
<li><ul>
<li>CD: 1.411 Mbps</li>
</ul>
</li>
<li><ul>
<li>MP3: 96, 128, 160 kbps</li>
</ul>
</li>
<li><ul>
<li>Internet telephony: 5.3 kbps and up</li>
</ul>
</li>
</ul>
<h3 id="Multimedia-video"><a href="#Multimedia-video" class="headerlink" title="Multimedia: video"></a>Multimedia: video</h3><ul>
<li>video: sequence of images displayed at constant rate</li>
<li><ul>
<li>e.g., 24 images/sec</li>
</ul>
</li>
<li>digital image: array of pixels</li>
<li><ul>
<li>each pixel represented by bits</li>
</ul>
</li>
<li><p>coding: use redundancy <strong>within</strong> and <strong>between</strong> images to decrease # bits used to encode image</p>
</li>
<li><ul>
<li>spatial (within image)</li>
</ul>
</li>
<li><ul>
<li>temporal (from one image to next)</li>
</ul>
</li>
</ul>
<blockquote>
<p><img src="\img\multimedia_video.png" alt="multimedia_video.png"></p>
</blockquote>
<ul>
<li><strong>CBR: (constant bit rate)</strong>: video encoding rate fixed</li>
<li><p><strong>VBR: (variable bit rate)</strong>: video encoding rate changes as amount of spatial, temporal coding changes </p>
</li>
<li><p>examples:</p>
</li>
<li><ul>
<li>MPEG 1 (CD-ROM) 1.5 Mbps</li>
</ul>
</li>
<li><ul>
<li>MPEG2 (DVD) 3-6 Mbps</li>
</ul>
</li>
<li><ul>
<li>MPEG4 (often used in Internet, &lt; 1 Mbps)</li>
</ul>
</li>
</ul>
<h3 id="Multimedia-networking-3-application-types"><a href="#Multimedia-networking-3-application-types" class="headerlink" title="Multimedia networking: 3 application types"></a>Multimedia networking: 3 application types</h3><ul>
<li><strong>streaming, stored</strong> audio, video</li>
<li><ul>
<li><em>streaming</em>: can begin playout before downloading entire file</li>
</ul>
</li>
<li><ul>
<li><em>stored(at server)</em>: can transmit faster than audio/video will be rendered (implies storing/buffering at client)</li>
</ul>
</li>
<li><ul>
<li>e.g., YouTube, Netflix, Hulu</li>
</ul>
</li>
<li><p><strong>conversational</strong> voice/video over IP </p>
</li>
<li><ul>
<li>interactive nature of human-to-human conversation limits delay tolerance</li>
</ul>
</li>
<li><ul>
<li>e.g., Skype</li>
</ul>
</li>
<li><p><strong>streaming live</strong> audio, video</p>
</li>
<li><ul>
<li>e.g., live sporting event (futbol)</li>
</ul>
</li>
</ul>
<h2 id="streaming-stored-video"><a href="#streaming-stored-video" class="headerlink" title="streaming stored video"></a>streaming stored video</h2><blockquote>
<p><img src="\img\streaming_stored_video.png" alt="streaming_stored_video.png"></p>
</blockquote>
<h3 id="Streaming-stored-video-challenges"><a href="#Streaming-stored-video-challenges" class="headerlink" title="Streaming stored video: challenges"></a>Streaming stored video: challenges</h3><ul>
<li><strong>continuous playout constraint</strong>: once client playout begins, playback must match original timing </li>
<li><ul>
<li>… but <strong>network delays are variable</strong>(jitter), so will need <em>client-side buffer</em> to match playout requirements</li>
</ul>
</li>
<li>other challenges:</li>
<li><ul>
<li>client interactivity: pause, fast-forward, rewind, jump through video</li>
</ul>
</li>
<li><ul>
<li>video packets may be lost, retransmitted</li>
</ul>
</li>
</ul>
<h3 id="Streaming-stored-video-revisited"><a href="#Streaming-stored-video-revisited" class="headerlink" title="Streaming stored video: revisited"></a>Streaming stored video: revisited</h3><blockquote>
<p><img src="\img\streaming_stored_video_revisited.png" alt="streaming_stored_video_revisited.png"></p>
</blockquote>
<ul>
<li><strong>client-side buffering and playout delay</strong>: compensate for network-added delay, delay jitter</li>
</ul>
<blockquote>
<p><img src="\img\streaming_stored_video_clientSideBuffering.png" alt="streaming_stored_video_clientSideBuffering.png"></p>
</blockquote>
<ul>
<li><ol>
<li>Initial fill of buffer until playout begins at $t_p$</li>
</ol>
</li>
<li><ol>
<li>playout begins at $t_p$, </li>
</ol>
</li>
<li><ol>
<li>buffer fill level varies over time as fill rate $x(t)$ varies and playout rate $r$ is constant</li>
</ol>
</li>
<li><p>playout buffering: average fill rate (x’), playout rate (r):</p>
</li>
<li><ul>
<li>x’ &lt; r: buffer eventually empties (causing freezing of video playout until buffer again fills)</li>
</ul>
</li>
<li><ul>
<li>x’ &gt; r: buffer will not empty, provided initial playout delay is large enough to absorb variability in x(t)</li>
</ul>
</li>
<li><ul>
<li><ul>
<li><strong>initial playout delay tradeoff</strong>: buffer starvation less likely with larger delay, but larger delay until user begins watching</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="Streaming-multimedia-UDP"><a href="#Streaming-multimedia-UDP" class="headerlink" title="Streaming multimedia: UDP"></a>Streaming multimedia: UDP</h3><ul>
<li>server sends at rate appropriate for client </li>
<li><ul>
<li>often: send rate = encoding rate = constant rate</li>
</ul>
</li>
<li><ul>
<li>transmission rate can be oblivious to congestion levels</li>
</ul>
</li>
<li>short playout delay (2-5 seconds) to remove network jitter</li>
<li>error recovery: application-level, time permitting</li>
<li>RTP [RFC 2326]: multimedia payload types</li>
<li>UDP may not go through firewalls</li>
</ul>
<h3 id="Streaming-multimedia-HTTP"><a href="#Streaming-multimedia-HTTP" class="headerlink" title="Streaming multimedia: HTTP"></a>Streaming multimedia: HTTP</h3><ul>
<li>multimedia file retrieved via HTTP GET</li>
<li>send at maximum possible rate under TCP</li>
<li>fill rate fluctuates(起伏) due to TCP congestion control, retransmissions (in-order delivery)</li>
<li>larger playout delay: smooth TCP delivery rate</li>
<li>HTTP/TCP passes more easily through firewalls</li>
</ul>
<h2 id="voice-over-IP"><a href="#voice-over-IP" class="headerlink" title="voice-over-IP"></a>voice-over-IP</h2><ul>
<li><strong>VoIP end-end-delay requirement</strong>: <em>needed to maintain “conversational” aspect</em></li>
<li><ul>
<li>higher delays noticeable, impair interactivity</li>
</ul>
</li>
<li><ul>
<li>&lt; 150 msec:  good</li>
</ul>
</li>
<li><ul>
<li><blockquote>
<p>400 msec bad</p>
</blockquote>
</li>
</ul>
</li>
<li><ul>
<li>includes application-level (packetization, playout), network delays</li>
</ul>
</li>
<li><p><strong>session initialization</strong>: how does callee advertise IP address, port number, encoding algorithms?</p>
</li>
<li><strong>value-added services</strong>: call forwarding, screening, recording</li>
<li>emergency services: 911</li>
</ul>
<h3 id="VoIP-characteristics"><a href="#VoIP-characteristics" class="headerlink" title="VoIP characteristics"></a>VoIP characteristics</h3><ul>
<li>speaker’s audio: alternating talk spurts, silent periods.</li>
<li><ul>
<li>64 kbps during talk spurt</li>
</ul>
</li>
<li><ul>
<li>pkts generated only during talk spurts</li>
</ul>
</li>
<li><ul>
<li>20 msec chunks at 8 Kbytes/sec: 160 bytes of data</li>
</ul>
</li>
<li>application-layer header added to each chunk</li>
<li>chunk+header encapsulated into UDP or TCP segment</li>
<li>application sends segment into socket every 20 msec during talkspurt</li>
</ul>
<h3 id="VoIP-packet-loss-delay"><a href="#VoIP-packet-loss-delay" class="headerlink" title="VoIP: packet loss, delay"></a>VoIP: packet loss, delay</h3><ul>
<li><strong>network loss</strong>: IP datagram lost due to network congestion (router buffer overflow)</li>
<li><strong>delay loss</strong>: IP datagram arrives too late for playout at receiver</li>
<li><ul>
<li>delays: processing, queueing in network; end-system (sender, receiver) delays</li>
</ul>
</li>
<li><ul>
<li>typical maximum tolerable delay: 400 ms</li>
</ul>
</li>
<li><strong>loss tolerance</strong>: depending on voice encoding, loss concealment, packet loss rates between 1% and 10% can be tolerated</li>
</ul>
<p><strong>Delay jitter</strong></p>
<ul>
<li>end-to-end delays of two consecutive packets: difference can be more or less than 20 msec (transmission time difference)</li>
</ul>
<h3 id="VoIP-fixed-playout-delay"><a href="#VoIP-fixed-playout-delay" class="headerlink" title="VoIP: fixed playout delay"></a>VoIP: fixed playout delay</h3><ul>
<li>receiver attempts to playout each chunk exactly q msecs after chunk was generated.</li>
<li><ul>
<li>chunk has time stamp t: play out chunk at t+q </li>
</ul>
</li>
<li><ul>
<li>chunk arrives after t+q: data arrives too late for playout: data “lost”</li>
</ul>
</li>
<li>tradeoff in choosing q:</li>
<li><ul>
<li><strong>large q: less packet loss</strong></li>
</ul>
</li>
<li><ul>
<li>small q: better interactive experience</li>
</ul>
</li>
<li><p>sender generates packets every 20 msec during talk spurt.</p>
</li>
<li><ul>
<li>first packet received at time r</li>
</ul>
</li>
<li><ul>
<li>first playout schedule: begins at p</li>
</ul>
</li>
<li><ul>
<li>second playout schedule: begins at p’</li>
</ul>
</li>
</ul>
<blockquote>
<p><img src="\img\VoIP_fixed_playout_delay.png" alt="VoIP_fixed_playout_delay.png"></p>
</blockquote>
<h3 id="Adaptive-playout-delay"><a href="#Adaptive-playout-delay" class="headerlink" title="Adaptive playout delay"></a>Adaptive playout delay</h3><ul>
<li>goal: low playout delay, low late loss rate</li>
<li>approach: adaptive playout delay adjustment:</li>
<li><ul>
<li>estimate network delay, adjust playout delay at beginning of each talk spurt</li>
</ul>
</li>
<li><ul>
<li>silent periods compressed and elongated</li>
</ul>
</li>
<li><ul>
<li>chunks still played out every 20 msec during talk spurt</li>
</ul>
</li>
<li>adaptively estimate packet delay: (EWMA - exponentially weighted moving average, recall TCP RTT estimate): </li>
</ul>
<blockquote>
<p><img src="\img\VoIP_adaptive_playout_delay.png" alt="VoIP_adaptive_playout_delay.png"></p>
</blockquote>
<ul>
<li><p>also useful to estimate average deviation of delay, vi:<br>$$v<em>i = (1 - \beta)v</em>{i-1} + \beta|r_i – t_i – d_i|$$</p>
</li>
<li><p>estimates $d_i$, $v_i$ calculated for every received packet, but used only at start of talk spurt</p>
</li>
<li><p>for first packet in talk spurt, playout time is:<br>$$playout - time_i = t_i + d_i + Kv_i$$</p>
</li>
<li><p>remaining packets in talkspurt are played out periodically</p>
</li>
<li><p>Q: How does receiver determine whether packet is first in a talkspurt?</p>
</li>
<li>if no loss, receiver looks at successive timestamps</li>
<li><ul>
<li>difference of successive stamps &gt; 20 msec –&gt;talk spurt begins.</li>
</ul>
</li>
<li>with loss possible, receiver must look at both time stamps and sequence numbers</li>
<li><ul>
<li>difference of successive stamps &gt; 20 msec and sequence numbers without gaps –&gt; talk spurt begins.</li>
</ul>
</li>
</ul>
<h3 id="VoiP-recovery-from-packet-loss"><a href="#VoiP-recovery-from-packet-loss" class="headerlink" title="VoiP: recovery from packet loss"></a>VoiP: recovery from packet loss</h3><p>Challenge: recover from packet loss given small tolerable delay between original transmission and playout</p>
<ul>
<li>each ACK/NAK takes ~ one RTT</li>
<li>alternative: Forward Error Correction (FEC)</li>
<li><ul>
<li>send enough bits to allow recovery without retransmission (recall two-dimensional parity in Ch. 5)</li>
</ul>
</li>
<li><p><strong>simple FEC</strong>: </p>
</li>
<li><ul>
<li>for every group of n chunks, create redundant chunk by exclusive OR-ing n original chunks</li>
</ul>
</li>
<li><ul>
<li>send n+1 chunks, increasing bandwidth by factor 1/n</li>
</ul>
</li>
<li><ul>
<li>can reconstruct original n chunks if at most one lost chunk from n+1 chunks, with playout delay</li>
</ul>
</li>
<li><p><strong>another FEC scheme</strong>:</p>
</li>
<li><ul>
<li>“piggyback lower quality stream” </li>
</ul>
</li>
<li><ul>
<li>send lower resolution audio stream as redundant information</li>
</ul>
</li>
<li><ul>
<li>e.g., nominal stream PCM at 64 kbps and redundant stream GSM at 13 kbps</li>
</ul>
</li>
</ul>
<blockquote>
<p><img src="\img\VoIP_recovery_from_packet_loss.png" alt="VoIP_recovery_from_packet_loss.png"></p>
</blockquote>
<ul>
<li>non-consecutive loss: receiver can conceal loss </li>
<li><p>generalization: can also append (n-1)st and (n-2)nd low-bit rate chunk</p>
</li>
<li><p><strong>interleaving to conceal loss</strong>:</p>
</li>
<li><ul>
<li>audio chunks divided into smaller units, e.g. four 5 msec units per 20 msec audio chunk</li>
</ul>
</li>
<li><ul>
<li>packet contains small units from different chunks</li>
</ul>
</li>
<li><ul>
<li>if packet lost, still have most of every original chunk</li>
</ul>
</li>
<li><ul>
<li>no redundancy overhead, but increases playout delay</li>
</ul>
</li>
</ul>
<blockquote>
<p><img src="\img\VoIP_recovery_from_packet_loss2.png" alt="VoIP_recovery_from_packet_loss2.png"></p>
</blockquote>
<h3 id="Voice-over-IP-Skype"><a href="#Voice-over-IP-Skype" class="headerlink" title="Voice-over-IP: Skype"></a>Voice-over-IP: Skype</h3><ul>
<li>proprietary application-layer protocol (inferred via reverse engineering) </li>
<li><ul>
<li>encrypted msgs</li>
</ul>
</li>
<li>P2P components:</li>
<li><ul>
<li><strong>clients</strong>: Skype peers connect directly to each other for VoIP call</li>
</ul>
</li>
<li><ul>
<li><strong>super nodes (SN)</strong>: Skype peers with special functions</li>
</ul>
</li>
<li><ul>
<li><strong>overlay network</strong>: among SNs to locate SCs</li>
</ul>
</li>
<li><ul>
<li><strong>login server</strong></li>
</ul>
</li>
</ul>
<blockquote>
<p><img src="\img\Voice_over_IP_Skype.png" alt="Voice_over_IP_Skype.png"></p>
</blockquote>
<ul>
<li>Skype client operation:</li>
<li><ul>
<li><ol>
<li>joins Skype network by contacting SN (IP address cached) using TCP</li>
</ol>
</li>
</ul>
</li>
<li><ul>
<li><ol>
<li>logs-in (username, password) to centralized Skype login server</li>
</ol>
</li>
</ul>
</li>
<li><ul>
<li><ol>
<li>obtains IP address for callee from SN, SN overlay</li>
</ol>
</li>
</ul>
</li>
<li><ul>
<li><ul>
<li>or client buddy list</li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li><ol>
<li>initiate call directly to callee</li>
</ol>
</li>
</ul>
</li>
</ul>
<blockquote>
<p><img src="\img\Voice_over_IP_Skype2.png" alt="Voice_over_IP_Skype2.png"></p>
</blockquote>
<h3 id="Skype-peers-as-relays"><a href="#Skype-peers-as-relays" class="headerlink" title="Skype: peers as relays"></a>Skype: peers as relays</h3><ul>
<li>problem: both Alice, Bob are behind “NATs” </li>
<li>NAT prevents outside peer from initiating connection to insider peer</li>
<li><p>inside peer can initiate connection to outside </p>
</li>
<li><p>relay solution: Alice, Bob maintain open connection to their SNs</p>
</li>
<li><ul>
<li>Alice signals her SN to connect to Bob</li>
</ul>
</li>
<li><ul>
<li>Alice’s SN connects to Bob’s SN</li>
</ul>
</li>
<li><ul>
<li>Bob’s SN connects to Bob over open connection Bob initially initiated to his SN</li>
</ul>
</li>
</ul>
<h2 id="protocols-for-real-time-conversational-applications-RTP-SIP"><a href="#protocols-for-real-time-conversational-applications-RTP-SIP" class="headerlink" title="protocols for real-time conversational applications(RTP, SIP)"></a>protocols for real-time conversational applications(RTP, SIP)</h2><h3 id="Real-Time-Protocol-RTP"><a href="#Real-Time-Protocol-RTP" class="headerlink" title="Real-Time Protocol (RTP)"></a>Real-Time Protocol (RTP)</h3><ul>
<li>RTP specifies packet structure for packets carrying audio, video data</li>
<li>RFC 3550</li>
<li>RTP packet provides </li>
<li><ul>
<li>payload type identification</li>
</ul>
</li>
<li><ul>
<li>packet sequence numbering</li>
</ul>
</li>
<li><ul>
<li>time stamping</li>
</ul>
</li>
<li>RTP runs in end systems</li>
<li>RTP packets encapsulated in UDP segments</li>
<li>interoperability: if two VoIP applications run RTP, they may be able to work together</li>
</ul>
<p><strong>RTP runs on top of UDP</strong></p>
<ul>
<li>RTP libraries provide transport-layer interface<br>that extends UDP: </li>
<li><ul>
<li>port numbers, IP addresses</li>
</ul>
</li>
<li><ul>
<li>payload type identification</li>
</ul>
</li>
<li><ul>
<li>packet sequence numbering</li>
</ul>
</li>
<li><ul>
<li>time-stamping</li>
</ul>
</li>
</ul>
<blockquote>
<p><img src="\img\RTP.png" alt="RTP.png"></p>
</blockquote>
<ul>
<li>RTP example: sending 64 kbps PCM-encoded voice over RTP</li>
<li><ul>
<li>application collects encoded data in chunks, e.g., every 20 msec = 160 bytes in a chunk</li>
</ul>
</li>
<li><ul>
<li>audio chunk + RTP header form RTP packet, which is encapsulated in UDP segment </li>
</ul>
</li>
<li><ul>
<li>RTP header indicates type of audio encoding in each packet</li>
</ul>
</li>
<li><ul>
<li><ul>
<li>sender can change encoding during conference </li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li>RTP header also contains sequence numbers, timestamps</li>
</ul>
</li>
</ul>
<h3 id="RTP-and-QoS"><a href="#RTP-and-QoS" class="headerlink" title="RTP and QoS"></a>RTP and QoS</h3><ul>
<li>RTP does <em>not</em> provide any mechanism to ensure timely data delivery or other QoS  guarantees</li>
<li>RTP encapsulation only seen at end systems (not by intermediate routers)</li>
<li><ul>
<li>routers provide best-effort service, making no special effort to ensure that RTP packets arrive at destination in timely matter</li>
</ul>
</li>
</ul>
<h3 id="RTP-header"><a href="#RTP-header" class="headerlink" title="RTP header"></a>RTP header</h3><blockquote>
<p><img src="\img\RTP_header.png" alt="RTP_header.png"></p>
</blockquote>
<ul>
<li><strong>payload type (7 bits)</strong>: indicates type of encoding currently being used.  If sender changes encoding during call, sender informs receiver via payload type field</li>
<li><ul>
<li>Payload type 0: PCM mu-law, 64 kbps</li>
</ul>
</li>
<li><ul>
<li>Payload type 3: GSM, 13 kbps</li>
</ul>
</li>
<li><ul>
<li>Payload type 7: LPC, 2.4 kbps</li>
</ul>
</li>
<li><ul>
<li>Payload type 26: Motion JPEG</li>
</ul>
</li>
<li><ul>
<li>Payload type 31: H.261</li>
</ul>
</li>
<li><ul>
<li>Payload type 33: MPEG2 video</li>
</ul>
</li>
<li><p><strong>sequence # (16 bits)</strong>: increment by one for each RTP packet sent</p>
</li>
<li><ul>
<li>detect packet loss, restore packet sequence</li>
</ul>
</li>
<li><p><strong>timestamp field (32 bits long)</strong>: sampling instant of first byte in this RTP data packet</p>
</li>
<li><ul>
<li>for audio, timestamp clock increments by one for each sampling period (e.g., each 125 usecs for 8 KHz sampling clock) </li>
</ul>
</li>
<li><ul>
<li>if application generates chunks of 160 encoded samples, timestamp increases by 160 for each RTP packet when source is active. Timestamp clock continues to increase at constant rate when source is inactive.</li>
</ul>
</li>
<li><p><strong>SSRC field (32 bits long)</strong>:  identifies source of RTP stream. Each stream in RTP session has distinct SSRC</p>
</li>
</ul>
<h3 id="RTSP-RTP-programming-assignment"><a href="#RTSP-RTP-programming-assignment" class="headerlink" title="RTSP/RTP programming assignment"></a>RTSP/RTP programming assignment</h3><ul>
<li>build a server that encapsulates stored video frames into RTP packets</li>
<li><ul>
<li>grab video frame, add RTP headers, create UDP segments, send segments to UDP socket</li>
</ul>
</li>
<li><ul>
<li>include seq numbers and time stamps</li>
</ul>
</li>
<li><ul>
<li>client RTP provided for you</li>
</ul>
</li>
<li>also write client side of RTSP</li>
<li><ul>
<li>issue play/pause commands</li>
</ul>
</li>
<li><ul>
<li>server RTSP provided for you</li>
</ul>
</li>
</ul>
<h3 id="Real-Time-Control-Protocol-RTCP"><a href="#Real-Time-Control-Protocol-RTCP" class="headerlink" title="Real-Time Control Protocol (RTCP)"></a>Real-Time Control Protocol (RTCP)</h3><ul>
<li>works in conjunction with RTP</li>
<li>each participant in RTP session periodically sends RTCP control packets to all other participants</li>
<li>each RTCP packet contains sender and/or receiver reports</li>
<li><ul>
<li>report statistics useful to  application: # packets sent, # packets lost, interarrival jitter</li>
</ul>
</li>
<li>feedback used to control performance</li>
<li><ul>
<li>sender may modify its transmissions based on  feedback</li>
</ul>
</li>
</ul>
<h3 id="RTCP-multiple-multicast-senders"><a href="#RTCP-multiple-multicast-senders" class="headerlink" title="RTCP: multiple multicast senders"></a>RTCP: multiple multicast senders</h3><blockquote>
<p><img src="\img\RTCP.png" alt="RTCP.png"></p>
</blockquote>
<ul>
<li>each RTP session: typically a single multicast address; all RTP/RTCP packets belonging to session use multicast address</li>
<li>RTP, RTCP packets distinguished from each other via distinct port numbers</li>
<li>to limit traffic, each participant reduces RTCP traffic as number of conference participants increases </li>
</ul>
<h3 id="RTCP-packet-types"><a href="#RTCP-packet-types" class="headerlink" title="RTCP: packet types"></a>RTCP: packet types</h3><ul>
<li>receiver report packets:</li>
<li><ul>
<li>fraction of packets lost, last sequence number, average interarrival jitter</li>
</ul>
</li>
<li>sender report packets: </li>
<li><ul>
<li>SSRC of RTP stream, current time, number of packets sent, number of bytes sent </li>
</ul>
</li>
<li>source description packets: </li>
<li><ul>
<li>e-mail address of sender, sender’s name, SSRC of associated RTP stream </li>
</ul>
</li>
<li><ul>
<li>provide mapping between the SSRC and the user/host name</li>
</ul>
</li>
</ul>
<h3 id="RTCP-stream-synchronization"><a href="#RTCP-stream-synchronization" class="headerlink" title="RTCP: stream synchronization"></a>RTCP: stream synchronization</h3><ul>
<li>RTCP can synchronize different media streams within a RTP session </li>
<li><ul>
<li>e.g., video conferencing app: each sender generates one RTP stream for video, one for audio. </li>
</ul>
</li>
<li>timestamps in RTP packets tied to the video, audio sampling clocks</li>
<li><ul>
<li>not tied to wall-clock time</li>
</ul>
</li>
<li>each RTCP sender-report packet contains (for most recently generated packet in associated RTP stream):</li>
<li><ul>
<li>timestamp of RTP packet </li>
</ul>
</li>
<li><ul>
<li>wall-clock time for when packet was created</li>
</ul>
</li>
<li>receivers uses association to synchronize playout of audio, video </li>
</ul>
<h3 id="RTCP-bandwidth-scaling"><a href="#RTCP-bandwidth-scaling" class="headerlink" title="RTCP: bandwidth scaling"></a>RTCP: bandwidth scaling</h3><blockquote>
<p>RTCP attempts to limit its traffic to 5% of session bandwidth</p>
</blockquote>
<ul>
<li>example : one sender, sending video at 2 Mbps</li>
<li><ul>
<li>RTCP attempts to limit RTCP traffic to 100 Kbps</li>
</ul>
</li>
<li><ul>
<li>RTCP gives 75% of  rate to receivers; remaining 25% to sender</li>
</ul>
</li>
<li><ul>
<li>75 kbps is equally shared among receivers: </li>
</ul>
</li>
<li><ul>
<li><ul>
<li>with R receivers,  each receiver gets to send RTCP traffic at 75/R kbps. </li>
</ul>
</li>
</ul>
</li>
<li><ul>
<li>sender gets to send RTCP traffic at 25 kbps. </li>
</ul>
</li>
<li><ul>
<li>participant determines RTCP packet transmission period by calculating avg RTCP packet size (across entire session) and dividing by  allocated rate </li>
</ul>
</li>
</ul>
<h3 id="SIP-Session-Initiation-Protocol-RFC-3261"><a href="#SIP-Session-Initiation-Protocol-RFC-3261" class="headerlink" title="SIP: Session Initiation Protocol [RFC 3261]"></a>SIP: Session Initiation Protocol [RFC 3261]</h3><ul>
<li>long-term vision:</li>
<li><ul>
<li>all telephone calls, video conference calls take place over Internet</li>
</ul>
</li>
<li><ul>
<li>people identified by names or e-mail addresses, rather than by phone numbers</li>
</ul>
</li>
<li><ul>
<li>can reach callee (if callee so desires), no matter where callee roams, no matter what IP device callee is currently using</li>
</ul>
</li>
</ul>
<h3 id="SIP-services"><a href="#SIP-services" class="headerlink" title="SIP services"></a>SIP services</h3><ul>
<li>SIP provides mechanisms for call setup:</li>
<li><ul>
<li>for caller to let callee know she wants to establish a call</li>
</ul>
</li>
<li><ul>
<li>so caller, callee can agree on media type, encoding</li>
</ul>
</li>
<li><ul>
<li>to end call</li>
</ul>
</li>
<li>determine current IP address of callee:</li>
<li><ul>
<li>Maps identifier to current IP address</li>
</ul>
</li>
<li>call management:</li>
<li><ul>
<li>add new media streams during call</li>
</ul>
</li>
<li><ul>
<li>change encoding during call</li>
</ul>
</li>
<li><ul>
<li>invite others </li>
</ul>
</li>
<li><ul>
<li>transfer, hold calls</li>
</ul>
</li>
</ul>
<h3 id="Setting-up-a-call"><a href="#Setting-up-a-call" class="headerlink" title="Setting up a call"></a>Setting up a call</h3><p>Example: setting up call to known IP address</p>
<blockquote>
<p><img src="\img\SIP_setting_up_call.png" alt="SIP_setting_up_call.png"></p>
</blockquote>
<ul>
<li>Alice’s SIP invite message indicates her port number, IP address, encoding she prefers to receive (PCM mlaw)</li>
<li>Bob’s 200 OK message indicates his port number, IP address, preferred encoding (GSM)</li>
<li>SIP messages can be sent over TCP or UDP; here sent over RTP/UDP</li>
<li><p>default SIP port number is 5060</p>
</li>
<li><p>codec negotiation:</p>
</li>
<li><ul>
<li>suppose Bob doesn’t have PCM mlaw encoder </li>
</ul>
</li>
<li><ul>
<li>Bob will instead reply with 606 Not Acceptable Reply, listing his encoders. Alice can then send new INVITE message, advertising different encoder</li>
</ul>
</li>
<li><p>rejecting a call</p>
</li>
<li><ul>
<li>Bob can reject with replies “busy,” “gone,” “payment required,” “forbidden”</li>
</ul>
</li>
<li><p>media can be sent over RTP or some other protocol</p>
</li>
</ul>
<h3 id="Example-of-SIP-message"><a href="#Example-of-SIP-message" class="headerlink" title="Example of SIP message"></a>Example of SIP message</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">INVITE sip:bob@domain.com SIP/2.0</div><div class="line">Via: SIP/2.0/UDP 167.180.112.24</div><div class="line">From: sip:alice@hereway.com</div><div class="line">To: sip:bob@domain.com </div><div class="line">Call-ID: a2e3a@pigeon.hereway.com</div><div class="line">Content-Type: application/sdp</div><div class="line">Content-Length: 885</div><div class="line"></div><div class="line">c=IN IP4 167.180.112.24</div><div class="line">m=audio 38060 RTP/AVP 0</div></pre></td></tr></table></figure>
<ul>
<li>Notes:</li>
<li><ul>
<li>HTTP message syntax</li>
</ul>
</li>
<li><ul>
<li>sdp = session description protocol</li>
</ul>
</li>
<li><ul>
<li>Call-ID is unique for every call</li>
</ul>
</li>
<li><p>Here we don’t know Bob’s IP address</p>
</li>
<li><ul>
<li>intermediate SIP servers needed</li>
</ul>
</li>
<li>Alice sends, receives SIP messages using SIP default port 5060</li>
<li>Alice specifies in header that SIP client sends, receives SIP messages over UDP</li>
</ul>
<h3 id="Name-translation-user-location"><a href="#Name-translation-user-location" class="headerlink" title="Name translation, user location"></a>Name translation, user location</h3><ul>
<li>caller wants to call callee, but only has callee’s name or e-mail address.</li>
<li>need to get IP address of callee’s current host:</li>
<li><ul>
<li>user moves around</li>
</ul>
</li>
<li><ul>
<li>DHCP protocol</li>
</ul>
</li>
<li><ul>
<li>user has different IP devices (PC, smartphone, car device)</li>
</ul>
</li>
<li><p>result can be based on:</p>
</li>
<li><ul>
<li>time of day (work, home)</li>
</ul>
</li>
<li><ul>
<li>caller (don’t want boss to call you at home)</li>
</ul>
</li>
<li><ul>
<li>status of callee (calls sent to voicemail when callee is already talking to someone)</li>
</ul>
</li>
</ul>
<h3 id="SIP-registrar"><a href="#SIP-registrar" class="headerlink" title="SIP registrar"></a>SIP registrar</h3><ul>
<li>one function of SIP server: <strong>registrar</strong></li>
<li>when Bob starts SIP client, client sends SIP REGISTER message to Bob’s registrar server</li>
</ul>
<p>register message:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">REGISTER sip:domain.com SIP/2.0</div><div class="line">Via: SIP/2.0/UDP 193.64.210.89 </div><div class="line">From: sip:bob@domain.com</div><div class="line">To: sip:bob@domain.com</div><div class="line">Expires: 3600</div></pre></td></tr></table></figure>
<h3 id="SIP-proxy"><a href="#SIP-proxy" class="headerlink" title="SIP proxy"></a>SIP proxy</h3><ul>
<li>another function of SIP server: <strong>proxy</strong></li>
<li>Alice sends invite message to her proxy server</li>
<li><ul>
<li>contains address sip:bob@domain.com</li>
</ul>
</li>
<li><ul>
<li>proxy responsible for routing SIP messages to callee, possibly through multiple proxies</li>
</ul>
</li>
<li>Bob sends response back through same set of SIP proxies</li>
<li>proxy returns Bob’s SIP response message to Alice </li>
<li><ul>
<li>contains Bob’s IP address</li>
</ul>
</li>
<li>SIP proxy analogous to local DNS server plus TCP setup</li>
</ul>
<blockquote>
<p><img src="\img\SIP_example.png" alt="SIP_example.png"></p>
</blockquote>
<h3 id="Comparison-with-H-323"><a href="#Comparison-with-H-323" class="headerlink" title="Comparison with H.323"></a>Comparison with H.323</h3><ul>
<li>H.323: another signaling protocol for real-time, interactive multimedia</li>
<li>H.323: complete, vertically integrated suite of protocols for multimedia conferencing: signaling, registration, admission control, transport, codecs</li>
<li>SIP: single component. Works with RTP, but does not mandate it. Can be combined with other protocols, services</li>
<li>H.323 comes from the ITU (telephony)</li>
<li>SIP comes from IETF: borrows much of its concepts from HTTP</li>
<li><ul>
<li>SIP has Web flavor; H.323 has telephony flavor</li>
</ul>
</li>
<li>SIP uses KISS principle: Keep It Simple Stupid</li>
</ul>
<h2 id="network-support-for-multimedia"><a href="#network-support-for-multimedia" class="headerlink" title="network support for multimedia"></a>network support for multimedia</h2><blockquote>
<p><img src="\img\network_support_for_multimedia.png" alt="network_support_for_multimedia.png"></p>
</blockquote>
<h3 id="Dimensioning-best-effort-networks"><a href="#Dimensioning-best-effort-networks" class="headerlink" title="Dimensioning best effort networks"></a>Dimensioning best effort networks</h3><ul>
<li>approach: deploy enough link capacity so that congestion doesn’t occur, multimedia traffic flows without delay or loss</li>
<li><ul>
<li>low complexity of network mechanisms (use current “best effort” network)</li>
</ul>
</li>
<li><ul>
<li>high bandwidth costs</li>
</ul>
</li>
<li><p>challenges:</p>
</li>
<li><ul>
<li><em>network dimensioning</em>: how much bandwidth is “enough?”</li>
</ul>
</li>
<li><ul>
<li><em>estimating network traffic demand</em>: needed to determine how much bandwidth is “enough” (for that much traffic)</li>
</ul>
</li>
</ul>
<h3 id="Providing-multiple-classes-of-service"><a href="#Providing-multiple-classes-of-service" class="headerlink" title="Providing multiple classes of service"></a>Providing multiple classes of service</h3><ul>
<li>thus far: making the best of best effort service</li>
<li><ul>
<li>one-size fits all service model</li>
</ul>
</li>
<li>alternative: multiple classes of service</li>
<li><ul>
<li>partition traffic into classes</li>
</ul>
</li>
<li><ul>
<li>network treats different classes of traffic differently (analogy: VIP service versus regular service)</li>
</ul>
</li>
<li>granularity: differential service among multiple classes, <em>not among individual connections</em></li>
<li>history: ToS bits</li>
</ul>
<p>Multiple classes of service: scenario</p>
<ul>
<li>mixed HTTP and VoIP</li>
<li>example:  1Mbps VoIP, HTTP share 1.5 Mbps link. </li>
<li><ul>
<li>HTTP bursts can congest router, cause audio loss</li>
</ul>
</li>
<li><ul>
<li>want to give priority to audio over HTTP</li>
</ul>
</li>
<li><p>Principle 1</p>
</li>
<li><ul>
<li>packet marking needed for router to distinguish between different classes; and new router policy to treat packets accordingly</li>
</ul>
</li>
<li><p>what if applications misbehave (VoIP sends higher than declared rate)</p>
</li>
<li><ul>
<li>policing: force source adherence to bandwidth allocations</li>
</ul>
</li>
<li><p>marking, policing at network edge</p>
</li>
<li><p>Principle 2</p>
</li>
<li><ul>
<li>provide protection (isolation) for one class from others</li>
</ul>
</li>
</ul>
<blockquote>
<p><img src="\img\QoS_guarantee.png" alt="QoS_guarantee.png"></p>
</blockquote>
<ul>
<li><p>allocating fixed (non-sharable) bandwidth to flow: inefficient use of bandwidth if flows doesn’t use its allocation</p>
</li>
<li><p>Principle 3</p>
</li>
<li><ul>
<li>while providing isolation, it is desirable to use<br>resources as efficiently as possible</li>
</ul>
</li>
</ul>
<h3 id="Scheduling-and-policing-mechanisms"><a href="#Scheduling-and-policing-mechanisms" class="headerlink" title="Scheduling and policing mechanisms"></a>Scheduling and policing mechanisms</h3><ul>
<li><p><strong>packet scheduling</strong>: choose next queued packet to send on outgoing link</p>
</li>
<li><p>Policing mechanisms</p>
</li>
<li>goal: limit traffic to not exceed declared parameters</li>
</ul>
<p>Three common-used criteria: </p>
<ul>
<li><em>(long term) average rate</em>: how many pkts can be sent per unit time (in the long run)</li>
<li><ul>
<li>crucial question: what is the interval length: 100 packets per sec or 6000 packets per min have same average!</li>
</ul>
</li>
<li><em>peak rate</em>: e.g., 6000 pkts per min (ppm) avg.; 1500 ppm peak rate</li>
<li><em>(max.) burst size</em>: max number of pkts sent consecutively (with no intervening idle)</li>
</ul>
<h3 id="Policing-mechanisms-implementation"><a href="#Policing-mechanisms-implementation" class="headerlink" title="Policing mechanisms: implementation"></a>Policing mechanisms: implementation</h3><ul>
<li><strong>token bucket</strong>: limit input to specified <em>burst size</em> and <em>average rate</em></li>
</ul>
<blockquote>
<p><img src="\img\token_bucket.png" alt="token_bucket.png"></p>
</blockquote>
<ul>
<li>bucket can hold b tokens</li>
<li>tokens generated at rate r token/sec unless bucket full</li>
<li><strong>over interval of length t: number of packets admitted less than or equal to  (r t + b)</strong></li>
</ul>
<h3 id="Policing-and-QoS-guarantees"><a href="#Policing-and-QoS-guarantees" class="headerlink" title="Policing and QoS guarantees"></a>Policing and QoS guarantees</h3><ul>
<li>token bucket, WFQ combine to provide guaranteed upper bound on delay, i.e., <strong>QoS guarantee!</strong></li>
</ul>
<blockquote>
<p><img src="\img\QoS_tokenBucket_WFQ.png" alt="QoS_tokenBucket_WFQ.png"></p>
</blockquote>
<h3 id="Differentiated-services"><a href="#Differentiated-services" class="headerlink" title="Differentiated services"></a>Differentiated services</h3><ul>
<li>want “qualitative” service classes</li>
<li><ul>
<li>“behaves like a wire”</li>
</ul>
</li>
<li><ul>
<li>relative service distinction: Platinum, Gold, Silver</li>
</ul>
</li>
<li><strong>scalability</strong>: simple functions in network core, relatively complex functions at edge routers (or hosts)</li>
<li><ul>
<li>signaling, maintaining per-flow router state difficult with large number of flows </li>
</ul>
</li>
<li>don’t define service classes, provide functional components to build service classes</li>
</ul>
<p><strong>Diffserv architecture</strong></p>
<blockquote>
<p><img src="\img\diffserv_architecture.png" alt="diffserv_architecture.png"></p>
</blockquote>
<p><strong>Edge-router packet marking</strong></p>
<ul>
<li>profile: pre-negotiated rate r, bucket size b</li>
<li><p>packet marking at edge based on <em>per-flow</em> profile</p>
</li>
<li><p>possible use of marking:</p>
</li>
<li><ul>
<li>class-based marking: packets of different classes marked differently</li>
</ul>
</li>
<li><ul>
<li>intra-class marking: conforming portion of flow marked differently than non-conforming one</li>
</ul>
</li>
</ul>
<p><strong>Diffserv packet marking: details</strong></p>
<ul>
<li>packet is marked in the Type of Service (TOS) in IPv4, and Traffic Class in IPv6</li>
<li>6 bits used for Differentiated Service Code Point (DSCP)</li>
<li><ul>
<li>determine PHB that the packet will receive</li>
</ul>
</li>
<li><ul>
<li>2 bits currently unused</li>
</ul>
</li>
</ul>
<h3 id="Classification-conditioning"><a href="#Classification-conditioning" class="headerlink" title="Classification, conditioning"></a>Classification, conditioning</h3><ul>
<li>may be desirable to limit traffic injection rate of some class:</li>
<li><ul>
<li>user declares traffic profile (e.g., rate, burst size)</li>
</ul>
</li>
<li><ul>
<li>traffic metered, shaped if non-conforming </li>
</ul>
</li>
</ul>
<blockquote>
<p><img src="\img\classification_conditioning.png" alt="classification_conditioning.png"></p>
</blockquote>
<h3 id="Forwarding-Per-hop-Behavior-PHB"><a href="#Forwarding-Per-hop-Behavior-PHB" class="headerlink" title="Forwarding Per-hop Behavior (PHB)"></a>Forwarding Per-hop Behavior (PHB)</h3><ul>
<li>PHB result in a different observable (measurable) forwarding performance behavior</li>
<li>PHB does not specify what mechanisms to use to ensure required PHB performance behavior</li>
<li>examples: </li>
<li><ul>
<li>class A gets x% of outgoing link bandwidth over time intervals of a specified length</li>
</ul>
</li>
<li><ul>
<li>class A packets leave first before packets from class B</li>
</ul>
</li>
</ul>
<p>PHBs proposed:</p>
<ul>
<li>expedited forwarding: packet departure rate of a class equals or exceeds specified rate </li>
<li><ul>
<li>logical link with a minimum guaranteed rate</li>
</ul>
</li>
<li><ul>
<li>low delay, low loss and low jitter, suitable for voice, video and other realtime services</li>
</ul>
</li>
<li>assured forwarding: 4 classes of traffic</li>
<li><ul>
<li>each guaranteed minimum amount of bandwidth</li>
</ul>
</li>
<li><ul>
<li>each with three drop preference partitions</li>
</ul>
</li>
</ul>
<h3 id="Per-connection-QOS-guarantees"><a href="#Per-connection-QOS-guarantees" class="headerlink" title="Per-connection QOS guarantees"></a>Per-connection QOS guarantees</h3><ul>
<li><p>basic fact of life: can not support traffic demands beyond link capacity</p>
</li>
<li><p>Principle 4</p>
</li>
<li><ul>
<li>call admission: flow declares its needs, network may block call (e.g., busy signal) if it cannot meet needs</li>
</ul>
</li>
</ul>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/computer-network/" rel="tag"># computer network</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/06/28/computer_network/computer_network_6：无线网络和移动网络(Wireless and Mobile Networks)/" rel="next" title="无线网络和移动网络(Wireless and Mobile Networks)">
                <i class="fa fa-chevron-left"></i> 无线网络和移动网络(Wireless and Mobile Networks)
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/06/30/computer_network/computer_network_8：网络安全(Security)/" rel="prev" title="网络安全(Security)">
                网络安全(Security) <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/img/avatar.jpg"
               alt="chenxf" />
          <p class="site-author-name" itemprop="name">chenxf</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
            
              <a href="/archives/">
            
                <span class="site-state-item-count">87</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">14</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/chenxfeng" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                    
                      GitHub
                    
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://weibo.com/3034124347" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                    
                      Weibo
                    
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#multimedia-networking-applications"><span class="nav-number">1.</span> <span class="nav-text">multimedia networking applications</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Multimedia-audio"><span class="nav-number">1.1.</span> <span class="nav-text">Multimedia: audio</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Multimedia-video"><span class="nav-number">1.2.</span> <span class="nav-text">Multimedia: video</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Multimedia-networking-3-application-types"><span class="nav-number">1.3.</span> <span class="nav-text">Multimedia networking: 3 application types</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#streaming-stored-video"><span class="nav-number">2.</span> <span class="nav-text">streaming stored video</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Streaming-stored-video-challenges"><span class="nav-number">2.1.</span> <span class="nav-text">Streaming stored video: challenges</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Streaming-stored-video-revisited"><span class="nav-number">2.2.</span> <span class="nav-text">Streaming stored video: revisited</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Streaming-multimedia-UDP"><span class="nav-number">2.3.</span> <span class="nav-text">Streaming multimedia: UDP</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Streaming-multimedia-HTTP"><span class="nav-number">2.4.</span> <span class="nav-text">Streaming multimedia: HTTP</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#voice-over-IP"><span class="nav-number">3.</span> <span class="nav-text">voice-over-IP</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#VoIP-characteristics"><span class="nav-number">3.1.</span> <span class="nav-text">VoIP characteristics</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#VoIP-packet-loss-delay"><span class="nav-number">3.2.</span> <span class="nav-text">VoIP: packet loss, delay</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#VoIP-fixed-playout-delay"><span class="nav-number">3.3.</span> <span class="nav-text">VoIP: fixed playout delay</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Adaptive-playout-delay"><span class="nav-number">3.4.</span> <span class="nav-text">Adaptive playout delay</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#VoiP-recovery-from-packet-loss"><span class="nav-number">3.5.</span> <span class="nav-text">VoiP: recovery from packet loss</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Voice-over-IP-Skype"><span class="nav-number">3.6.</span> <span class="nav-text">Voice-over-IP: Skype</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Skype-peers-as-relays"><span class="nav-number">3.7.</span> <span class="nav-text">Skype: peers as relays</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#protocols-for-real-time-conversational-applications-RTP-SIP"><span class="nav-number">4.</span> <span class="nav-text">protocols for real-time conversational applications(RTP, SIP)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Real-Time-Protocol-RTP"><span class="nav-number">4.1.</span> <span class="nav-text">Real-Time Protocol (RTP)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RTP-and-QoS"><span class="nav-number">4.2.</span> <span class="nav-text">RTP and QoS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RTP-header"><span class="nav-number">4.3.</span> <span class="nav-text">RTP header</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RTSP-RTP-programming-assignment"><span class="nav-number">4.4.</span> <span class="nav-text">RTSP/RTP programming assignment</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Real-Time-Control-Protocol-RTCP"><span class="nav-number">4.5.</span> <span class="nav-text">Real-Time Control Protocol (RTCP)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RTCP-multiple-multicast-senders"><span class="nav-number">4.6.</span> <span class="nav-text">RTCP: multiple multicast senders</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RTCP-packet-types"><span class="nav-number">4.7.</span> <span class="nav-text">RTCP: packet types</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RTCP-stream-synchronization"><span class="nav-number">4.8.</span> <span class="nav-text">RTCP: stream synchronization</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RTCP-bandwidth-scaling"><span class="nav-number">4.9.</span> <span class="nav-text">RTCP: bandwidth scaling</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SIP-Session-Initiation-Protocol-RFC-3261"><span class="nav-number">4.10.</span> <span class="nav-text">SIP: Session Initiation Protocol [RFC 3261]</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SIP-services"><span class="nav-number">4.11.</span> <span class="nav-text">SIP services</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Setting-up-a-call"><span class="nav-number">4.12.</span> <span class="nav-text">Setting up a call</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Example-of-SIP-message"><span class="nav-number">4.13.</span> <span class="nav-text">Example of SIP message</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Name-translation-user-location"><span class="nav-number">4.14.</span> <span class="nav-text">Name translation, user location</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SIP-registrar"><span class="nav-number">4.15.</span> <span class="nav-text">SIP registrar</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SIP-proxy"><span class="nav-number">4.16.</span> <span class="nav-text">SIP proxy</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Comparison-with-H-323"><span class="nav-number">4.17.</span> <span class="nav-text">Comparison with H.323</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#network-support-for-multimedia"><span class="nav-number">5.</span> <span class="nav-text">network support for multimedia</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Dimensioning-best-effort-networks"><span class="nav-number">5.1.</span> <span class="nav-text">Dimensioning best effort networks</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Providing-multiple-classes-of-service"><span class="nav-number">5.2.</span> <span class="nav-text">Providing multiple classes of service</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Scheduling-and-policing-mechanisms"><span class="nav-number">5.3.</span> <span class="nav-text">Scheduling and policing mechanisms</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Policing-mechanisms-implementation"><span class="nav-number">5.4.</span> <span class="nav-text">Policing mechanisms: implementation</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Policing-and-QoS-guarantees"><span class="nav-number">5.5.</span> <span class="nav-text">Policing and QoS guarantees</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Differentiated-services"><span class="nav-number">5.6.</span> <span class="nav-text">Differentiated services</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Classification-conditioning"><span class="nav-number">5.7.</span> <span class="nav-text">Classification, conditioning</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Forwarding-Per-hop-Behavior-PHB"><span class="nav-number">5.8.</span> <span class="nav-text">Forwarding Per-hop Behavior (PHB)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Per-connection-QOS-guarantees"><span class="nav-number">5.9.</span> <span class="nav-text">Per-connection QOS guarantees</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2017 &mdash; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">chenxf</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动</div>

  <span class="post-meta-divider">|</span>

  <div class="theme-info">主题 &mdash; <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.2</div>


        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.2"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  








  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->





  

  

  

  
  


  

  

</body>
</html>
